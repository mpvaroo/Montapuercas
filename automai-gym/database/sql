CREATE DATABASE IF NOT EXISTS automai_gym
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

USE automai_gym;

-- 1) ROLES
CREATE TABLE roles (
  id_rol INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  nombre_rol VARCHAR(30) NOT NULL UNIQUE,
  descripcion_rol VARCHAR(120) NULL
) ENGINE=InnoDB;

-- 2) USUARIOS
CREATE TABLE usuarios (
  id_usuario INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  correo_usuario VARCHAR(120) NOT NULL UNIQUE,
  hash_contrasena_usuario VARCHAR(255) NOT NULL,
  nombre_mostrado_usuario VARCHAR(80) NOT NULL,
  estado_usuario ENUM('activo','bloqueado','pendiente') NOT NULL DEFAULT 'activo',
  fecha_creacion_usuario DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_ultimo_acceso_usuario DATETIME NULL
) ENGINE=InnoDB;

-- 3) USUARIOS_ROLES
CREATE TABLE usuarios_roles (
  id_usuario_rol INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL,
  id_rol INT UNSIGNED NOT NULL,
  fecha_asignacion_rol DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_usuarios_roles_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_usuarios_roles_rol
    FOREIGN KEY (id_rol) REFERENCES roles(id_rol)
    ON DELETE RESTRICT ON UPDATE CASCADE,
  UNIQUE KEY uq_usuario_rol (id_usuario, id_rol)
) ENGINE=InnoDB;

-- 4) PERFIL
CREATE TABLE perfiles_usuario (
  id_perfil_usuario INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL UNIQUE,
  nombre_real_usuario VARCHAR(100) NULL,
  telefono_usuario VARCHAR(30) NULL,
  ruta_foto_perfil_usuario VARCHAR(180) NULL,
  objetivo_principal_usuario ENUM('definir','volumen','rendimiento','salud') NOT NULL DEFAULT 'salud',
  dias_entrenamiento_semana_usuario TINYINT UNSIGNED NOT NULL DEFAULT 3,
  nivel_usuario ENUM('principiante','intermedio','avanzado') NOT NULL DEFAULT 'principiante',
  peso_kg_usuario DECIMAL(5,2) NULL,
  altura_cm_usuario SMALLINT UNSIGNED NULL,
  fecha_inicio_usuario DATE NULL,
  CONSTRAINT fk_perfiles_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 5) AJUSTES
CREATE TABLE ajustes_usuario (
  id_ajustes_usuario INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL UNIQUE,
  notificaciones_entrenamiento_activas TINYINT(1) NOT NULL DEFAULT 1,
  notificaciones_clases_activas TINYINT(1) NOT NULL DEFAULT 1,
  tono_ia_coach ENUM('directo','motivador') NOT NULL DEFAULT 'directo',
  idioma_preferido ENUM('es','en') NOT NULL DEFAULT 'es',
  semana_empieza_en ENUM('lunes','domingo') NOT NULL DEFAULT 'lunes',
  CONSTRAINT fk_ajustes_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 6) SEGURIDAD (simple)
CREATE TABLE seguridad_usuario (
  id_seguridad_usuario INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL UNIQUE,
  requiere_cambio_contrasena TINYINT(1) NOT NULL DEFAULT 0,
  fecha_ultimo_cambio_contrasena DATETIME NULL,
  intentos_fallidos_login INT UNSIGNED NOT NULL DEFAULT 0,
  fecha_ultimo_intento_fallido DATETIME NULL,
  CONSTRAINT fk_seguridad_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 7) TIPOS CLASE
CREATE TABLE tipos_clase (
  id_tipo_clase INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  nombre_tipo_clase VARCHAR(60) NOT NULL UNIQUE,
  descripcion_tipo_clase VARCHAR(180) NULL
) ENGINE=InnoDB;

-- 8) CLASES GIMNASIO (ADMIN)
CREATE TABLE clases_gimnasio (
  id_clase_gimnasio INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_tipo_clase INT UNSIGNED NOT NULL,
  titulo_clase VARCHAR(100) NOT NULL,
  descripcion_clase VARCHAR(220) NULL,
  instructor_clase VARCHAR(80) NULL,
  fecha_inicio_clase DATETIME NOT NULL,
  fecha_fin_clase DATETIME NOT NULL,
  cupo_maximo_clase SMALLINT UNSIGNED NOT NULL DEFAULT 20,
  estado_clase ENUM('borrador','publicada','cancelada') NOT NULL DEFAULT 'publicada',
  fecha_creacion_clase DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_clases_tipo
    FOREIGN KEY (id_tipo_clase) REFERENCES tipos_clase(id_tipo_clase)
    ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_clases_fecha (fecha_inicio_clase),
  INDEX idx_clases_estado (estado_clase)
) ENGINE=InnoDB;

-- 9) RESERVAS
CREATE TABLE reservas_clase (
  id_reserva_clase INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL,
  id_clase_gimnasio INT UNSIGNED NOT NULL,
  estado_reserva ENUM('reservada','cancelada','asistio','no_asistio') NOT NULL DEFAULT 'reservada',
  fecha_reserva DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  origen_reserva ENUM('usuario','ia_coach') NOT NULL DEFAULT 'usuario',
  notas_reserva VARCHAR(180) NULL,
  CONSTRAINT fk_reservas_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_reservas_clase
    FOREIGN KEY (id_clase_gimnasio) REFERENCES clases_gimnasio(id_clase_gimnasio)
    ON DELETE CASCADE ON UPDATE CASCADE,
  UNIQUE KEY uq_usuario_clase (id_usuario, id_clase_gimnasio),
  INDEX idx_reservas_clase (id_clase_gimnasio, estado_reserva)
) ENGINE=InnoDB;

-- 10) CHECK-IN
CREATE TABLE checkin_reserva (
  id_checkin_reserva INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_reserva_clase INT UNSIGNED NOT NULL UNIQUE,
  realizado_checkin TINYINT(1) NOT NULL DEFAULT 0,
  fecha_checkin DATETIME NULL,
  metodo_checkin ENUM('manual','qr','recepcion') NOT NULL DEFAULT 'manual',
  CONSTRAINT fk_checkin_reserva
    FOREIGN KEY (id_reserva_clase) REFERENCES reservas_clase(id_reserva_clase)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 11) EJERCICIOS (catálogo base)
CREATE TABLE ejercicios (
  id_ejercicio INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  nombre_ejercicio VARCHAR(120) NOT NULL UNIQUE,
  grupo_muscular_principal ENUM('pecho','espalda','pierna','hombro','biceps','triceps','core','cardio','fullbody') NOT NULL,
  descripcion_ejercicio VARCHAR(220) NULL
) ENGINE=InnoDB;

-- 12) RUTINAS USUARIO (creadas por usuario o IA)
CREATE TABLE rutinas_usuario (
  id_rutina_usuario INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL,
  nombre_rutina_usuario VARCHAR(140) NOT NULL,
  objetivo_rutina_usuario ENUM('definir','volumen','rendimiento','salud') NOT NULL DEFAULT 'salud',
  nivel_rutina_usuario ENUM('principiante','intermedio','avanzado') NOT NULL DEFAULT 'principiante',
  duracion_estimada_minutos SMALLINT UNSIGNED NULL,
  origen_rutina ENUM('usuario','ia_coach','plantilla') NOT NULL DEFAULT 'usuario',
  instrucciones_rutina TEXT NULL,
  fecha_creacion_rutina DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  rutina_activa TINYINT(1) NOT NULL DEFAULT 1,
  CONSTRAINT fk_rutinas_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE,
  INDEX idx_rutinas_usuario (id_usuario, rutina_activa)
) ENGINE=InnoDB;

-- 13) RUTINAS_EJERCICIOS (detalle de la rutina)
CREATE TABLE rutinas_ejercicios (
  id_rutina_ejercicio INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_rutina_usuario INT UNSIGNED NOT NULL,
  id_ejercicio INT UNSIGNED NOT NULL,
  orden_en_rutina SMALLINT UNSIGNED NOT NULL DEFAULT 1,
  series_objetivo SMALLINT UNSIGNED NOT NULL DEFAULT 3,
  repeticiones_objetivo VARCHAR(30) NOT NULL DEFAULT '8-12',
  peso_objetivo_kg DECIMAL(6,2) NULL,
  rpe_objetivo DECIMAL(3,1) NULL,
  descanso_segundos SMALLINT UNSIGNED NULL,
  notas_ejercicio VARCHAR(220) NULL,
  CONSTRAINT fk_rutina_ejercicio_rutina
    FOREIGN KEY (id_rutina_usuario) REFERENCES rutinas_usuario(id_rutina_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_rutina_ejercicio_ejercicio
    FOREIGN KEY (id_ejercicio) REFERENCES ejercicios(id_ejercicio)
    ON DELETE RESTRICT ON UPDATE CASCADE,
  INDEX idx_rutina_detalle (id_rutina_usuario, orden_en_rutina)
) ENGINE=InnoDB;

-- 14) REGISTROS DE PROGRESO (peso/medidas/métricas)
CREATE TABLE registros_progreso (
  id_registro_progreso INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL,
  fecha_registro DATE NOT NULL,
  peso_kg_registro DECIMAL(5,2) NULL,
  cintura_cm_registro DECIMAL(5,2) NULL,
  pecho_cm_registro DECIMAL(5,2) NULL,
  cadera_cm_registro DECIMAL(5,2) NULL,
  notas_progreso VARCHAR(220) NULL,
  CONSTRAINT fk_progreso_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE,
  UNIQUE KEY uq_usuario_fecha (id_usuario, fecha_registro),
  INDEX idx_progreso_fecha (fecha_registro)
) ENGINE=InnoDB;

-- 15) CONVERSACIONES IA (un hilo por usuario)
CREATE TABLE conversaciones_ia (
  id_conversacion_ia INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_usuario INT UNSIGNED NOT NULL,
  titulo_conversacion VARCHAR(120) NULL,
  fecha_creacion_conversacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  conversacion_activa TINYINT(1) NOT NULL DEFAULT 1,
  CONSTRAINT fk_conversacion_usuario
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
    ON DELETE CASCADE ON UPDATE CASCADE,
  INDEX idx_conversacion_usuario (id_usuario, conversacion_activa)
) ENGINE=InnoDB;

-- 16) MENSAJES IA (historial + acciones)
CREATE TABLE mensajes_ia (
  id_mensaje_ia INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  id_conversacion_ia INT UNSIGNED NOT NULL,
  rol_mensaje ENUM('usuario','asistente','sistema') NOT NULL,
  contenido_mensaje TEXT NOT NULL,
  -- JSON con acciones tipo:
  -- {"accion":"crear_rutina","id_rutina_usuario":123}
  -- {"accion":"reservar_clase","id_clase_gimnasio":55,"resultado":"ok"}
  acciones_mensaje JSON NULL,
  fecha_mensaje DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_mensajes_conversacion
    FOREIGN KEY (id_conversacion_ia) REFERENCES conversaciones_ia(id_conversacion_ia)
    ON DELETE CASCADE ON UPDATE CASCADE,
  INDEX idx_mensajes_conversacion (id_conversacion_ia, fecha_mensaje)
) ENGINE=InnoDB;

-- SEMILLAS MINIMAS
INSERT INTO roles (nombre_rol, descripcion_rol) VALUES
('usuario', 'Acceso a zona usuario'),
('admin', 'Acceso a panel admin');

INSERT INTO tipos_clase (nombre_tipo_clase, descripcion_tipo_clase) VALUES
('Yoga Flow', 'Movilidad y respiración'),
('HIIT Express', 'Alta intensidad 30-45 min'),
('Fuerza', 'Fuerza guiada'),
('Spinning', 'Ciclismo indoor');

INSERT INTO ejercicios (nombre_ejercicio, grupo_muscular_principal, descripcion_ejercicio) VALUES
('Press banca', 'pecho', 'Press en banco con barra'),
('Dominadas', 'espalda', 'Tracción vertical con peso corporal'),
('Sentadilla', 'pierna', 'Sentadilla con barra'),
('Curl bíceps', 'biceps', 'Curl con mancuernas o barra'),
('Plancha', 'core', 'Isométrico de core');
